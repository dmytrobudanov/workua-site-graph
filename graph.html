<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>work.ua site graph</title>
  <style>
    html, body { margin: 0; height: 100%; background: #0b0f14; }
    #graph { width: 100%; height: 100%; }
    #hud{
      position: absolute; left: 12px; top: 12px; z-index: 10;
      background: rgba(0,0,0,.55); color: #fff; padding: 10px 12px;
      font: 13px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Arial;
      border-radius: 12px; max-width: 720px; backdrop-filter: blur(6px);
    }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:8px;}
    .pill { padding:4px 8px; border-radius: 999px; background: rgba(255,255,255,.08); cursor:pointer; user-select:none; }
    .pill input { vertical-align: middle; }
    .small { opacity:.85; font-size: 12px; }
    #search { width: 260px; max-width: 60vw; padding: 6px 8px; border-radius: 10px; border: 1px solid rgba(255,255,255,.15); background: rgba(0,0,0,.35); color: #fff; }
    .btn { padding: 6px 10px; border-radius: 10px; border: 1px solid rgba(255,255,255,.15); background: rgba(255,255,255,.08); color:#fff; cursor:pointer; }
    .btn:active { transform: translateY(1px); }
  </style>
</head>
<body>
  <div id="hud">
    <div><b>work.ua graph</b> — drag rotate, scroll zoom</div>
    <div class="small">Click = focus, right-click = open URL</div>

    <div id="stats" class="row small"></div>

    <div class="row">
      <input id="search" placeholder="Find URL contains... (e.g. /articles/)" />
      <button class="btn" id="btnFocus">Focus</button>
      <button class="btn" id="btnReset">Reset</button>
    </div>

    <div class="row">
      <button class="btn" id="btnAll">All</button>
      <button class="btn" id="btnJobs">Only /jobs</button>
      <button class="btn" id="btnArticles">Only /articles</button>
      <button class="btn" id="btnNews">Only /news</button>
      <button class="btn" id="btnEmployer">Only /employer</button>
      <button class="btn" id="btnHubs">Hubs top 5%</button>
    </div>

    <div class="row">
      <label class="pill">
        <input type="checkbox" id="chkHideLeaf" checked />
        hide leaf (IN ≤ 1)
      </label>

      <label class="pill">
        Min IN:
        <input type="range" id="rngMinIn" min="0" max="50" value="0" style="vertical-align:middle; width:140px;" />
        <span id="lblMinIn" class="small">0</span>
      </label>

      <label class="pill">
        <input type="checkbox" id="chkHighlightHubs" checked />
        highlight hubs (top 5%)
      </label>
    </div>


    <div class="row small" id="filters"></div>
    <div id="sel" class="small" style="margin-top:8px;"></div>
  </div>

  <div id="graph"></div>

  <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
  <script src="https://unpkg.com/3d-force-graph@1.73.4/dist/3d-force-graph.min.js"></script>

  <script>
    const stats = document.getElementById('stats');
    const sel = document.getElementById('sel');
    const filtersEl = document.getElementById('filters');
    const searchEl = document.getElementById('search');

    const btnFocus = document.getElementById('btnFocus');
    const btnReset = document.getElementById('btnReset');
    const btnAll = document.getElementById('btnAll');
    const btnJobs = document.getElementById('btnJobs');
    const btnArticles = document.getElementById('btnArticles');
    const btnNews = document.getElementById('btnNews');
    const btnEmployer = document.getElementById('btnEmployer');
    const btnHubs = document.getElementById('btnHubs');
    const chkHideLeaf = document.getElementById('chkHideLeaf');
    const rngMinIn = document.getElementById('rngMinIn');
    const lblMinIn = document.getElementById('lblMinIn');
    const chkHighlightHubs = document.getElementById('chkHighlightHubs');

    // Разделы + цвета
    const SECTIONS = [
      {key:'jobs',     label:'/jobs',     test:(u)=>u.includes('/jobs'),     color:0x4cc9f0},
      {key:'articles', label:'/articles', test:(u)=>u.includes('/articles'), color:0xf72585},
      {key:'news',     label:'/news',     test:(u)=>u.includes('/news'),     color:0xfee440},
      {key:'employer', label:'/employer', test:(u)=>u.includes('/employer'), color:0x80ed99},
      {key:'other',    label:'other',     test:(u)=>true,                    color:0xbdb2ff}
    ];

    const enabled = new Set(SECTIONS.map(s=>s.key));
    let fullData = null;

    function sectionOf(url){
      for (const s of SECTIONS){
        if (s.key === 'other') continue;
        if (s.test(url)) return s.key;
      }
      return 'other';
    }
    function colorOf(sectionKey){
      const s = SECTIONS.find(x=>x.key===sectionKey) || SECTIONS[SECTIONS.length-1];
      return s.color;
    }

    function renderFilters(){
      filtersEl.innerHTML = '';
      for (const s of SECTIONS){
        const checked = enabled.has(s.key) ? 'checked' : '';
        const wrap = document.createElement('label');
        wrap.className = 'pill';
        wrap.innerHTML = `<input type="checkbox" ${checked}/> ${s.label}`;
        wrap.querySelector('input').addEventListener('change', (e)=>{
          if (e.target.checked) enabled.add(s.key);
          else enabled.delete(s.key);
          applyFilter();
        });
        filtersEl.appendChild(wrap);
      }
    }

    // --- 3D graph setup
    const Graph = ForceGraph3D()(document.getElementById('graph'))
      .backgroundColor('#0b0f14')
      .linkOpacity(0.12)
      .onNodeClick(node => focusNode(node))
      .onNodeRightClick(node => window.open(node.id, '_blank'));

    // node render: размер зависит от indegree
    Graph.nodeThreeObject(node => {
      const r = node.size || 2.0; // радиус
      const geo = new THREE.SphereGeometry(r, 12, 12);
      const hubColor = 0xff6b6b; // цвет хабов
      const baseColor = colorOf(node.section);
      const c = (chkHighlightHubs && chkHighlightHubs.checked && node.isHub) ? hubColor : baseColor;
      const mat = new THREE.MeshBasicMaterial({ color: c });
      return new THREE.Mesh(geo, mat);
    });

    // tooltip: раздел + url + in/out
    Graph.nodeLabel(n =>
      `${n.section}\n${n.id}\nIN: ${n.in || 0} | OUT: ${n.out || 0}`
    );




    function focusNode(node){
      const distance = 160;
      const distRatio = 1 + distance / Math.hypot(node.x, node.y, node.z);

      Graph.cameraPosition(
        { x: node.x * distRatio, y: node.y * distRatio, z: node.z * distRatio },
        node,
        800
      );

      const url = node.id;
      sel.innerHTML = `
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <span>Selected:</span>
          <a href="${url}" target="_blank" rel="noopener noreferrer"
             style="color:#9bd; text-decoration:underline; word-break:break-all;">
            ${url}
          </a>
          <span style="opacity:.8">(${node.section}) IN=${node.in||0} OUT=${node.out||0}</span>
          <button class="btn" id="copyLinkBtn" style="padding:4px 8px;">Copy</button>
        </div>
      `;

      // кнопка копирования
      const btn = document.getElementById("copyLinkBtn");
      if (btn) {
        btn.addEventListener("click", async () => {
          try {
            await navigator.clipboard.writeText(url);
            btn.textContent = "Copied!";
            setTimeout(() => (btn.textContent = "Copy"), 1200);
          } catch (e) {
            // fallback: выделить текст
            prompt("Copy URL:", url);
          }
        });
      }
    }


    function setOnlySection(sectionKey){
      enabled.clear();
      enabled.add(sectionKey);
      renderFilters();
      applyFilter();
    }

    function setAll(){
      enabled.clear();
      SECTIONS.forEach(s=>enabled.add(s.key));
      renderFilters();
      applyFilter(true);
    }

    function reset(){
      sel.innerHTML = '';
      searchEl.value = '';
      setAll();
      if (fullData) Graph.graphData(fullData);
      if (chkHideLeaf) chkHideLeaf.checked = true;
      if (chkHighlightHubs) chkHighlightHubs.checked = true;
      if (rngMinIn) rngMinIn.value = 0;
      if (lblMinIn) lblMinIn.textContent = "0";
    }


    function applyFilter(updateStats=false){
      if (!fullData) return;

      const minIn = Number(rngMinIn?.value || 0);
      if (lblMinIn) lblMinIn.textContent = String(minIn);

      const hideLeaf = !!(chkHideLeaf && chkHideLeaf.checked);

      const okNode = (n)=> {
        if (!enabled.has(n.section)) return false;
        if (n.in < minIn) return false;
        if (hideLeaf && (n.in <= 1)) return false;
        return true;
      };

      const nodes = fullData.nodes.filter(okNode);
      const nodeSet = new Set(nodes.map(n=>n.id));
      const links = fullData.links.filter(l => nodeSet.has(l.source) && nodeSet.has(l.target));

      Graph.graphData({nodes, links});

      stats.innerHTML = `Showing: <b>${nodes.length}</b> nodes | <b>${links.length}</b> links` +
        ` <span style="opacity:.75">| minIN=${minIn}${hideLeaf ? ', hideLeaf' : ''}</span>`;
    }


    function findAndFocus(substr){
      if (!fullData) return;
      const q = (substr || '').trim().toLowerCase();
      if (!q) return;

      const node = fullData.nodes.find(n => n.id.toLowerCase().includes(q));
      if (!node) {
        sel.innerHTML = `Not found: <code>${q}</code>`;
        return;
      }

      // включим его секцию, чтобы точно показывалось
      enabled.add(node.section);
      renderFilters();
      applyFilter();

      const cur = Graph.graphData().nodes.find(n => n.id === node.id);
      if (cur) focusNode(cur);
    }

    // Hubs: top 5% by IN
    function showTopHubs(percent=5){
      if (!fullData) return;

      const nodesSorted = [...fullData.nodes].sort((a,b)=> (b.in||0) - (a.in||0));
      const k = Math.max(10, Math.floor(nodesSorted.length * (percent/100)));
      const top = new Set(nodesSorted.slice(0, k).map(n=>n.id));

      const nodes = fullData.nodes.filter(n => top.has(n.id));
      const nodeSet = new Set(nodes.map(n=>n.id));
      const links = fullData.links.filter(l => nodeSet.has(l.source) && nodeSet.has(l.target));

      Graph.graphData({nodes, links});
      stats.innerHTML = `Hubs top ${percent}%: <b>${nodes.length}</b> nodes | <b>${links.length}</b> links`;
      sel.innerHTML = `Mode: <b>Hubs top ${percent}%</b>`;
    }

    // UI events
    btnFocus.addEventListener('click', ()=> findAndFocus(searchEl.value));
    searchEl.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') findAndFocus(searchEl.value); });
    chkHideLeaf.addEventListener('change', ()=> applyFilter(true));
    chkHighlightHubs.addEventListener('change', ()=> {
      // пересоздаём объекты, чтобы перекрасилось
      Graph.nodeThreeObject(Graph.nodeThreeObject());
      applyFilter(false);
    });
    rngMinIn.addEventListener('input', ()=> applyFilter(true));

    btnReset.addEventListener('click', reset);
    btnAll.addEventListener('click', setAll);
    btnJobs.addEventListener('click', ()=> setOnlySection('jobs'));
    btnArticles.addEventListener('click', ()=> setOnlySection('articles'));
    btnNews.addEventListener('click', ()=> setOnlySection('news'));
    btnEmployer.addEventListener('click', ()=> setOnlySection('employer'));
    btnHubs.addEventListener('click', ()=> showTopHubs(5));

    // Load data
    fetch('./graph_clean_strict.json')
      .then(r => r.json())
      .then(data => {
        // section + degrees
        const byId = new Map();
        data.nodes.forEach(n => {
          n.section = sectionOf(n.id);
          n.in = 0; n.out = 0;
          byId.set(n.id, n);
        });

        // --- hubs: top 5% by IN (для подсветки)
        const nodesSorted = [...data.nodes].sort((a,b)=> (b.in||0) - (a.in||0));
        const hubK = Math.max(10, Math.floor(nodesSorted.length * 0.05));
        const hubSet = new Set(nodesSorted.slice(0, hubK).map(n=>n.id));
        data.nodes.forEach(n => n.isHub = hubSet.has(n.id));

        // links: ensure source/target strings and count degrees
        data.links.forEach(l => {
          const s = (typeof l.source === 'string') ? l.source : l.source.id;
          const t = (typeof l.target === 'string') ? l.target : l.target.id;
          l.source = s; l.target = t;

          const sn = byId.get(s);
          const tn = byId.get(t);
          if (sn) sn.out += 1;
          if (tn) tn.in += 1;
        });

        // size scaling by indegree
        const ins = data.nodes.map(n=>n.in||0).sort((a,b)=>a-b);
        const p50 = ins[Math.floor(ins.length*0.50)] || 1;
        const p90 = ins[Math.floor(ins.length*0.90)] || (p50+1);

        data.nodes.forEach(n=>{
          // radius 2..8 примерно
          const v = n.in || 0;
          const norm = Math.min(1, (v / Math.max(1, p90)));
          n.size = 2 + norm * 6;
        });

        fullData = data;
        renderFilters();

        Graph.graphData(fullData);
        stats.innerHTML = `Loaded: <b>${fullData.nodes.length}</b> nodes | <b>${fullData.links.length}</b> links`;

        Graph.d3Force('charge').strength(-55);
        Graph.d3Force('link').distance(26);
      })
      .catch(err => {
        stats.innerHTML = 'Failed to load graph.json';
        console.error(err);
      });
  </script>
</body>
</html>
